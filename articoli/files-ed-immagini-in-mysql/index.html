<!doctype html><html class=no-js lang=it><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Files ed immagini in MySQL - Giovanni Tomasicchio</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Memorizzare file e immagini in MySQL con PHP"><meta property="og:title" content="Files ed immagini in MySQL"><meta property="og:description" content="Memorizzare file e immagini in MySQL con PHP"><meta property="og:type" content="article"><meta property="og:url" content="https://giovannitomasicchio.github.io/articoli/files-ed-immagini-in-mysql/"><meta property="article:section" content="articoli"><meta property="article:published_time" content="2005-06-17T23:09:48+00:00"><meta property="article:modified_time" content="2005-06-17T23:09:48+00:00"><meta itemprop=name content="Files ed immagini in MySQL"><meta itemprop=description content="Memorizzare file e immagini in MySQL con PHP"><meta itemprop=datePublished content="2005-06-17T23:09:48+00:00"><meta itemprop=dateModified content="2005-06-17T23:09:48+00:00"><meta itemprop=wordCount content="1834"><meta itemprop=keywords content="database,MySQL,BLOB,FTP,mysqli,upload,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Files ed immagini in MySQL"><meta name=twitter:description content="Memorizzare file e immagini in MySQL con PHP"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,regular,italic,600,600italic,700,700italic,800,800italic|Kaushan+Script:regular"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-525H86QENV"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-525H86QENV',{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Giovanni Tomasicchio" rel=home><div class="logo__item logo__text"><div class=logo__title>Giovanni Tomasicchio</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/articoli/><span class=menu__text>Articoli PHP</span></a></li><li class=menu__item><a class=menu__link href=/corsi/><span class=menu__text>Corsi</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Files ed immagini in MySQL</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2005-06-17T23:09:48Z>17 June 2005</time></div></div></header><div class="content post__content clearfix"><p>Spesso si ha la necessità di realizzare un sito che permetta all&rsquo;utente di scaricare dei files. Altre volte invece bisogna realizzare delle gallerie di immagini. Nulla di particolarmente complicato, basta preparare delle pagine con dei classici links ai files in questione che avremo salvato sul server, magari in una apposita cartella, ed il gioco è fatto. E se volessimo rendere queste risorse accessibili solo a determinati utenti? In questo articolo vedremo come poter risolvere questo problema attraverso la <strong>memorizzazione dei files all&rsquo;interno di MySQL</strong>.</p><p>Se infatti i files sono conservati nel database, sarà l&rsquo;applicazione PHP a verificare se l&rsquo;utente ha i diritti necessari per accedervi e l&rsquo;utente non potrà bypassare in alcun modo questi controlli poiché sarà il PHP a fornirgli i files che richiede. Le possibilità sono innumerevoli, dalla creazione di complessi sistemi di distribuzione file alla realizzazione di tecniche anti-leach che eviteranno la creazione di links diretti di altri siti alle vostre risorse.</p><p>Per illustrare le linee guida da seguire nella creazione di un sistema di memorizzazione e recupero di files da MySQL realizzeremo tre semplici script. Il primo avrà il compito di prelevare un file inviato da un utente e di inserirlo in MySQL. Il secondo script genererà un elenco dei files presenti all&rsquo;interno del database. Cliccando su uno di questi link verrà lanciato il terzo script, che si occuperà dell&rsquo;estrazione del file selezionato e del suo invio al browser.</p><p>Per ragioni didattiche gli script proposti contengono le sole istruzione necessarie al raggiungimento nei vari scopi. Non possono essere quindi considerati pronti per l&rsquo;utilizzo in un sito web di produzione, ma costituiscono sicuramente un buon punto di partenza per coloro che vorranno implementare tali tecniche.</p><hr><h4 id=creazione-della-tabella-dei-files>Creazione della tabella dei files</h4><p>Per prima cosa dovremo creare una tabella all&rsquo;interno del nostro database MySQL che conterrà i files. Questa tabella sarà costituita dai seguenti campi:</p><p>Campo Tipo
-&mdash;&mdash;&ndash; &mdash;&mdash;&mdash;&mdash;&ndash;
id_file int(11) chiave primaria (autoincrement)
nome_file varchar(255)
tipo_file varchar(128)
dati_file blob</p><p>Vediamo il significato e l&rsquo;utilità dei diversi campi:</p><ul><li><strong>id_file</strong>
si tratta di un numero progressivo (ID) che ci servirà per identificare univocamente un file nel database.</li><li><strong>nome_file</strong>
conterrà il nome del file che va memorizzato esplicitamente.</li><li><strong>tipo_file</strong>
con questo campo teniamo nota del tipo di file. Memorizzeremo una stringa (tipo MIME) che ci verrà fornita dal browser durante l&rsquo;upload del file e che ci tornerà utile quando dovremo reinviare il file all&rsquo;utente.</li><li><strong>dati_file</strong>
questo campo conterrà il file vero e proprio, ovvero tutti i byte che lo costituiscono.</li></ul><p>Di particolare interessa è il campo dati_file di tipo <strong>blob</strong>. Il tipo blob (<strong>b</strong>inary <strong>l</strong>arge <strong>ob</strong>ject) è proprio quello che MySQL mette a disposizione per la memorizzazione di grosse quantità di dati binari ed è quindi adatto a conservare un intero file. In realtà ci sono diversi tipi blob, ciascuno caratterizzato da un valore massimo di byte che può contenere:</p><table><thead><tr><th><strong>Nome campo</strong></th><th><strong>Massima capacità</strong></th></tr></thead><tbody><tr><td>TINYBLOB</td><td>256 Byte</td></tr><tr><td>BLOB</td><td>64 KByte</td></tr><tr><td>MEDIUMBLOB</td><td>16 MByte</td></tr><tr><td>LONGBLOB</td><td>4 GByte</td></tr></tbody></table><p>Per creare la tabella possiamo eseguire la seguente query (ad esempio usando phpMyAdmin o direttamente con il MySQL Command Line Client):</p><pre><code>&lt;pre class=&quot;brush: sql&quot;&gt;
CREATE TABLE tabella_files ( 
   id_file int(11) NOT NULL auto_increment, 
   nome_file varchar(255) default NULL, 
   tipo_file varchar(128) default NULL, 
   dati_file blob, 
   PRIMARY KEY (`id_file`) 
);
</code></pre><hr><h4 id=upload-e-inserimento-in-mysql>Upload e inserimento in MySQL</h4><p>Il seguente script si occupa di inserire all&rsquo;interno della tabella appena creata un file inviato dall&rsquo;utente attraverso un form. Il principio di funzionamento è abbastanza semplice: la prima volta che viene eseguito lo script, viene chiamata la funzione<code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 187);"> mostra_form&lt;/span>&lt;/span></code> che si occupa di preparare il modulo per l&rsquo;upload del file. All&rsquo;invio del file si procede con il recupero del suo contenuto e con l&rsquo;inserimento nel database.</p><p>Non ci soffermiamo sui dettagli della procedura di upload del file, che non rientra nello scopo di questo articolo. Si noti solamente come sia possibile ricavare dall&rsquo;array <code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 187);">$_FILES&lt;/span>&lt;/span></code> alcune informazioni sul file ricevuto, in particolare il suo tipo MIME. Si tratta di una stringa che lo stesso browser invia insieme al file e che ne specifica il tipo. A esempio per una immagine in formato GIF questa stringa sarà &ldquo;image/gif&rdquo;. Per un elenco dei diversi tipi MIME è possibile consultare <a href=http://www.utoronto.ca/webdocs/HTMLdocs/Book/Book-3ed/appb/mimetype.html>questa pagina</a>.</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
&lt;?php 
// se è stato inviato il file...
if(isset($_POST['invia']))
{
   // se ci sono stati problemi nell'upload del file
   if(!isset($_FILES['file_inviato']) OR $_FILES['file_inviato']['error'] != UPLOAD_ERR_OK)
   mostra_form(&quot;errore nell'invio del file. Riprova&quot;);

   // connessione e selezione del database
   mysql_connect('localhost', 'utente_db', 'password_db')
   or die('Connessione non riuscita: ' . mysql_error());

   if(!mysql_select_db('nome_database'))
   die('Selezione database fallita!');

   // recupero alcune informazioni sul file inviato
   $nome_file_temporaneo = $_FILES['file_inviato']['tmp_name'];
   $nome_file_vero = $_FILES['file_inviato']['name'];
   $tipo_file = $_FILES['file_inviato']['type'];

   // leggo il contenuto del file
   $dati_file = file_get_contents($nome_file_temporaneo);

   // preparo il contenuto del file per la query
   $dati_file = addslashes($dati_file);

   // query per inserire il file nel DB
   $query = &quot;INSERT INTO tabella_files SET
               nome_file = '$nome_file_vero', 
               tipo_file = '$tipo_file', 
               dati_file = '$dati_file'&quot;; 

   mysql_query($query)
   OR die('Query non valida: ' . mysql_error());

   // mostro nuovamente il form ed un messaggio di successo
   mostra_form(&quot;Memorizzazione del file &lt;b&gt;$nome_file_vero&lt;/b&gt; nel database eseguita correttamente.&quot;);
}
else
{
   mostra_form();
}

/**
* Mostra il form per l'upload del file 
* 
*/ 
function mostra_form($messaggio = '')
{
   ?&gt; 
    
   &lt;head&gt; 
   &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt; 
   &lt;title&gt;Carica file nel database&lt;/title&gt; 
   &lt;/head&gt; 
    
   &lt;p&gt;&lt;?php echo $messaggio?&gt; &lt;br /&gt; Seleziona un file da memorizzare nel database: &lt;p&gt;&lt;/p&gt; 
   &lt;form name=&quot;form1&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;&quot;&gt; 
   &lt;p&gt; 
   &lt;input type=&quot;file&quot; name=&quot;file_inviato&quot;&gt; 
   &lt;p&gt;&lt;/p&gt; 
   &lt;p&gt; 
   &lt;input type=&quot;submit&quot; name=&quot;invia&quot; value=&quot;Invia file&quot;&gt; 
   &lt;p&gt;&lt;/p&gt; 
   &lt;/form&gt; 
    
    
   &lt;?php 
   exit();
}
?&gt;
</code></pre><p>Questo script non necessita di molti commenti, già presenti all&rsquo;interno del codice. Si noti come l&rsquo;inserimento di un file in MySQL si effettua attraverso una comune query INSERT.</p><hr><h4 id=elenco-dei-files>Elenco dei files</h4><p>Per permettere agli utenti di poter prelevare i files conservati nel database dobbiamo mostrarne un elenco. Niente di più semplice: il seguente script, attraverso una comune SELECT, recupera i nomi e gli ID dei files disponibili e costruisce dei links.</p><p>Questi links ovviamente non punteranno ai files, poiché questi non sono accessibili direttamente. I collegamenti saranno invece del tipo <code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(221, 0, 0);">mostra.php?id=32&lt;/span>&lt;/span></code> e punteranno quindi ad un ulteriore script che si occuperà dell&rsquo;invio dei files all&rsquo;utente, e che realizzeremo nella prossima pagina.</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
&lt;head&gt; 
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt; 
&lt;title&gt;Carica file nel database&lt;/title&gt; 
&lt;/head&gt; 

&lt;p&gt;&lt;b&gt;Clicca su uno dei seguenti file&lt;/b&gt;&lt;p&gt;&lt;p&gt;&lt;/p&gt; 
&lt;?php 
// connessione e selezione del database
mysql_connect('localhost', 'utente_db', 'password_db')
or die('Connessione non riuscita: ' . mysql_error());

if(!mysql_select_db('nome_database'))
die('Selezione database fallita!');

// query per ottenere l'elenco dei files nel DB
$query = &quot;SELECT * FROM tabella_files&quot;;

$risultato = mysql_query($query)
or die('Query non valida: ' . mysql_error());

// se ci sono files nel DB
if(mysql_numrows($risultato))
{
   // estrazione dei risultati e stampa dei links ai files
   while ($tmp = mysql_fetch_array($risultato))
   {
       echo &quot;&lt;p&gt;&lt;a href=\&quot;mostra.php?id=$tmp[id_file]\&quot;&gt;$tmp[nome_file]&lt;/a&gt;&lt;/p&gt;\n&quot;;
   }
}
else
{
   echo '&lt;p&gt;Nessun file presente nel database&lt;/p&gt;';
}
?&gt;  
</code></pre><hr><h4 id=estrazione-del-file>Estrazione del file</h4><p>Come abbiamo accennato precedentemente, l&rsquo;utente richiederà un file cliccando su un link del tipo <code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(221, 0, 0);">mostra.php?id=32&lt;/span>&lt;/span>&lt;/span></code>, ovvero passerà ad un ulteriore script (mostra.php) l&rsquo;ID del file di interesse. Il codice di seguito riportato si occupa proprio di gestire queste richieste. Niente di complicato: una volta recuperato l&rsquo;ID del file in questione si tratta di effettuare una SELECT per estrarre il file e inviarne il risultato al browser.</p><p>Per permettere al browser di maneggiare correttamente il file dobbiamo far uso di una intestazione (header) contenente il corretto tipo MIME associato a tale file. Questa informazione è presente nel campo tipo_file della nostra tabella.</p><p><strong>mostra.php</strong></p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
&lt;?php 
// connessione e selezione del database
mysql_connect('localhost', 'utente_db', 'password_db')
or die('Connessione non riuscita: ' . mysql_error());

if(!mysql_select_db('nome_database'))
die('Selezione database fallita!');

// query per recuperare il file
$query = 'SELECT * FROM tabella_files WHERE id_file = '.$_GET['id'];
$risultato = mysql_query($query) or die('Query non valida: ' . mysql_error());
$tmp = mysql_fetch_array($risultato);

// invio una intestazione contenente il tipo MIME
header('Content-Type: '.$tmp['tipo_file']);

// invio il contenuto del file
echo $tmp['dati_file'];
?&gt;  
</code></pre><p>Il funzionamento dello script si basa su 3 semplici passaggi: la query per il recupero del file il cui ID è conservato in <code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 187);">$_GET&lt;/span>&lt;span style="color: rgb(0, 119, 0);">[&lt;/span>&lt;span style="color: rgb(221, 0, 0);">'id'&lt;/span>&lt;span style="color: rgb(0, 119, 0);">]&lt;/span>&lt;/span>&lt;/span></code>, l&rsquo;invio dell&rsquo;intestazione contenente il tipo MIME attraverso l&rsquo;uso della funzione <code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 187);">header&lt;/span>&lt;/span>&lt;/span></code>, l&rsquo;invio del file al browser con una semplice <code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 119, 0);">echo&lt;/span>&lt;/span>&lt;/span></code>.</p><p>Nel caso in cui vogliamo che il browser non apra il file ma che proponga all&rsquo;utente di salvarlo sul PC, ovvero che venga effettuato il download, allora al posto dell&rsquo;intestazione:</p><p><code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 187);">header&lt;/span>&lt;span style="color: rgb(0, 119, 0);">(&lt;/span>&lt;span style="color: rgb(221, 0, 0);">'Content-Type: '&lt;/span>&lt;span style="color: rgb(0, 119, 0);">.&lt;/span>&lt;span style="color: rgb(0, 0, 187);">$tmp&lt;/span>&lt;span style="color: rgb(0, 119, 0);">[&lt;/span>&lt;span style="color: rgb(221, 0, 0);">'tipo_file'&lt;/span>&lt;span style="color: rgb(0, 119, 0);">]);&lt;/span>&lt;/span>&lt;/span></code></p><p>dovremo inviare le seguenti:</p><p><code>&lt;span style="color: rgb(0, 0, 0);">&lt;span style="color: rgb(0, 0, 187);">header&lt;/span>&lt;span style="color: rgb(0, 119, 0);">(&lt;/span>&lt;span style="color: rgb(221, 0, 0);">"Content-Type: application/octet-stream"&lt;/span>&lt;span style="color: rgb(0, 119, 0);">);&lt;br>&lt;/br> &lt;/span>&lt;span style="color: rgb(0, 0, 187);">header&lt;/span>&lt;span style="color: rgb(0, 119, 0);">(&lt;/span>&lt;span style="color: rgb(221, 0, 0);">"Content-Disposition: attachment; filename=\"$tmp[nome_file]\""&lt;/span>&lt;span style="color: rgb(0, 119, 0);">);&lt;/span>&lt;/span></code></p><hr><h4 id=alcune-considerazioni>Alcune considerazioni</h4><p>Diverse sono le problematiche da considerare quando si realizza un sistema di memorizzazione files in un database. Se infatti le potenzialità insite in questa tecnica sono molteplici e limitate solo dalla fantasia dello sviluppatore, d&rsquo;altro canto tali procedure non sono prive di inconvenienti.</p><p>Se ad esempio si lavora con grossi files la procedura di upload e memorizzazione potrebbe diventare estremamente onerosa e talvolta impossibile. Le cause potrebbero essere diverse e le variabili in gioco molteplici. Per convincersene basta pensare a quali e quanti siano gli elementi coinvolti in questa procedura:</p><ul><li>browser dell&rsquo;utente</li><li>rete internet</li><li>server web</li><li>php</li><li>mysql</li></ul><p>Oltre ad una adeguata configurazione del server web, di PHP (direttiva <em>upload_max_filesize</em> del php.ini) e MySQL (<em>max_allowed_packet</em>) , si potrebbe pensare di evitare la procedura di upload attraverso il browser e di portare i files direttamente sul server, magari via FTP, per poi caricarne il contenuto all&rsquo;interno del database.</p><p>Poiché nella creazione della tabella destinata alla memorizzazione dei file abbiamo utilizzato un campo blob, la massima dimensione che questi possono avere è 64KByte. Per inserire file più grandi basta modificare il tipo di campo, magari in MEDIUMBLOG o LONGBLOB.</p><p>Sempre a causa delle dimensioni, la procedura proposta per l&rsquo;inserimento del file in MySQL potrebbe risultare inefficiente. Questa infatti prevede la lettura completa del file che viene riversato in una variabile, inserita nella query ed inviata al database. E' possibile risolvere questa inefficiente gestione della memoria solo con l&rsquo;utilizzo delle funzioni messe a disposizione della nuova estensione <em>ext/mysqli</em>. In particolare il metodo <a href=http://www.php.net/manual/it/function.mysqli-send-long-data.php>send_long_data</a> della classe mysqli_stmt, insieme all&rsquo;istruzione fread per la lettura del file, permetterebbero una processazione del file a blocchi di byte. Per maggiori informazioni potete consultare <a href=http://www.phpnews.it/articoli/php/estensione-mysqli-iii/4/>questa pagina</a>.</p><p>Infine occorre considerare che la conservazione di files all&rsquo;interno di MySQL complica le normali operazioni di back-up e ripristino del database, costringendoci a maneggiare archivi di grosse dimensioni.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/database/ rel=tag>database</a></li><li class=tags__item><a class="tags__link btn" href=/tags/mysql/ rel=tag>MySQL</a></li><li class=tags__item><a class="tags__link btn" href=/tags/blob/ rel=tag>BLOB</a></li><li class=tags__item><a class="tags__link btn" href=/tags/ftp/ rel=tag>FTP</a></li><li class=tags__item><a class="tags__link btn" href=/tags/mysqli/ rel=tag>mysqli</a></li><li class=tags__item><a class="tags__link btn" href=/tags/upload/ rel=tag>upload</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/articoli/creare-automaticamente-lintroduzione-di-un-testo/ rel=prev><span class=pager__subtitle>«&#8201;Precedente</span><p class=pager__title>Creare automaticamente l'introduzione di un testo</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/articoli/il-passaggio-delle-variabili-e-la-gestione-dello-stato/ rel=next><span class=pager__subtitle>Prossimo&#8201;»</span><p class=pager__title>Il passaggio delle variabili e la gestione dello stato</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Giovanni Tomasicchio.
<span class=footer__copyright-credits>Generato con <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> e il tema <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>