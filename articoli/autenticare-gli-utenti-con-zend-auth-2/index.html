<!doctype html><html class=no-js lang=it><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Autenticare gli utenti con Zend_Auth - 2 - Giovanni Tomasicchio</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Creare un sistema di login in PHP con Zend_Auth utilizzando Zend_Auth_Adapter_DbTable per l'accesso ala database"><meta property="og:title" content="Autenticare gli utenti con Zend_Auth - 2"><meta property="og:description" content="Creare un sistema di login in PHP con Zend_Auth utilizzando Zend_Auth_Adapter_DbTable per l'accesso ala database"><meta property="og:type" content="article"><meta property="og:url" content="https://giovannitomasicchio.github.io/articoli/autenticare-gli-utenti-con-zend-auth-2/"><meta property="article:section" content="articoli"><meta property="article:published_time" content="2007-09-15T09:29:38+00:00"><meta property="article:modified_time" content="2007-09-15T09:29:38+00:00"><meta itemprop=name content="Autenticare gli utenti con Zend_Auth - 2"><meta itemprop=description content="Creare un sistema di login in PHP con Zend_Auth utilizzando Zend_Auth_Adapter_DbTable per l'accesso ala database"><meta itemprop=datePublished content="2007-09-15T09:29:38+00:00"><meta itemprop=dateModified content="2007-09-15T09:29:38+00:00"><meta itemprop=wordCount content="1273"><meta itemprop=keywords content="database,Zend Framework,MySQL,crittografia,CSS,exception,XML,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Autenticare gli utenti con Zend_Auth - 2"><meta name=twitter:description content="Creare un sistema di login in PHP con Zend_Auth utilizzando Zend_Auth_Adapter_DbTable per l'accesso ala database"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,regular,italic,600,600italic,700,700italic,800,800italic|Kaushan+Script:regular"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-525H86QENV"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-525H86QENV',{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Giovanni Tomasicchio" rel=home><div class="logo__item logo__text"><div class=logo__title>Giovanni Tomasicchio</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/articoli/><span class=menu__text>Articoli PHP</span></a></li><li class=menu__item><a class=menu__link href=/corsi/><span class=menu__text>Corsi</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Autenticare gli utenti con Zend_Auth - 2</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2007-09-15T09:29:38Z>15 September 2007</time></div></div></header><div class="content post__content clearfix"><h3 id=zend_auth_adapter_dbtable>Zend_Auth_Adapter_DbTable</h3><p>Nel precedente articolo abbiamo analizzato i diversi componenti che concorrono alla realizzazione del sistema di autenticazione utente presente nello Zend Framework. In particolare abbiamo visto come il controllo delle credenziali dell&rsquo;utente avviene grazie ad una classe detta Adapter. Tra gli Adapter già presenti nello Zend Framework vi è <strong>Zend_Auth_Adapter_DbTable</strong> che può essere usato per confrontare lo username e la password forniti dall&rsquo;utente con quelli memorizzati in una tabella di un database.</p><p>Per accedere al database lo Zend_Auth_Adapter_DbTable necessita di una connessione al database, ovvero di uno Zend_Db_Adapter, oggetto che deve essere fornito direttamente al costruttore della classe. Gli ulteriori parametri per configurare Zend_Auth_Adapter_DbTable sono:</p><ul><li><strong>tableName</strong>: il nome della tabella del database che contiene username e password di tutti gli utenti, utilizzate per la verifica delle credenziali durante il login.</li><li><strong>identityColumn</strong>: il nome della colonna della tabella del database che contiene l&rsquo;username degli utenti registrati.</li><li><strong>credentialColumn</strong>: il nome della colonna che contiene la password degli utenti.</li><li><strong>credentialTreatment</strong>: indica un eventuale sistema utilizzato per oscurare le password all&rsquo;interno del database (crittografica, hash, ecc.). Ad esempio, se in un database MySQL vengono conservati gli hash MD5 delle password bisogna specificare &lsquo;MD5(?)&rsquo;. Si noti che credentialTreatment non fa riferimento ad una funzione PHP bensì ad una funzione del database impiegato.</li></ul><p>Lo username e la password da verificare vengono fornite all&rsquo;Adapter attraverso i metodi <strong>setIdentity($username)</strong> e <strong>setCredential($password)</strong>. Come per qualsiasi Adapter, il metodo authenticate() effettua il controllo di questi dati e restituisce un oggetto di tipo Zend_Auth_Result che, oltre a contenere l&rsquo;esito della procedura, contiene anche lo username dell&rsquo;utente. Se si procede con una autenticazione indiretta (si ricordi quanto detto nel precedente articolo) questa sarà l&rsquo;unica informazione che Zend_Auth conserverà nello Storage.</p><p>Spesso però è conveniente rendere persistenti ulteriori informazioni relative all&rsquo;utente loggato (ad esempio user_id, data ultimo accesso, nome da mostrare, ecc.) e alcune di queste informazioni risiedono proprio sullo stesso record della tabella utenti utilizzata per l&rsquo;autenticazione appena effettuata. Per questa ragione Zend_Auth_Adapter_DbTable fornisce il metodo <strong>getResultRowObject()</strong> per recuperare anche le altre informazioni presenti nel record della tabella utenti. Effettuando una autenticazione indiretta potremo memorizzare tali informazioni nello Storage di Zend_Auth.</p><p>getResultRowObject() permette anche di recuperare solo alcune informazioni dal record della tabella. Se ad esempio vogliamo recuperare solo i campi &ldquo;campo1&rdquo; e &ldquo;campo2&rdquo; bisogna procedere in questo modo:</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
$my_auth_adapter-&gt;getResultRowObject(array('campo1', 'campo2'));
</code></pre><p>Se invece vogliamo recuperare tutti i campi tranne &ldquo;campo3&rdquo; e &ldquo;campo4&rdquo;:</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
$my_auth_adapter-&gt;getResultRowObject(null, array('campo3', 'campo4'));
</code></pre><hr><h3 id=applicazione-di-esempio>Applicazione di esempio</h3><p>Nelle pagine che seguono realizzeremo una piccola applicazione per vedere all&rsquo;opera il componente Zend_Auth ed applicare in un caso concreto alcune delle tecniche illustrate in questo e nel precedente articolo. L&rsquo;applicazione è costituita da un unico Controller, IndexController, e da un unico template index.phtml che realizza un semplice form di login. Ad autenticazione avvenuta, con lo stesso template mostreremo un messaggio di benvenuto ed un link per effettuare il logout. L&rsquo;ErrorController ed il relativo template non saranno realizzati.</p><p>L&rsquo;Adapter impiegato è lo Zend_Auth_Adapter_DbTable che utilizza una connessione a MySQL, creata nel file di bootstrap, ed una tabella di nome &ldquo;users&rdquo; che è possibile creare con le seguenti query:</p><pre><code>&lt;pre class=&quot;brush: sql&quot;&gt;
CREATE TABLE `users` (
  `user_id` int(11) NOT NULL auto_increment,
  `user_name` varchar(32) default NULL,
  `password` varchar(32) default NULL,
  `nome` varchar(32) default NULL,
  PRIMARY KEY  (`user_id`)
);


insert into `users` (`user_name`, `password`, `nome`) values('mario76','525d5d4f0cfb94d045c48971aa1aa974','mario rossi');
</code></pre><p>La query di inserimento è utile per popolare la tabella degli utenti in modo da poter subito provare l&rsquo;applicazione effettuando il login conusername &ldquo;mario76&rdquo; e password &ldquo;segreto&rdquo;, memorizzata con il suo hash MD 5. Non verranno realizzate pagine per la creazione degli utenti, operazione che viene lasciata al lettore che potrà prendere spunto daltutorial sullo Zend Framework.</p><p>Potete scaricare tutti gli script realizzati da <a href=http://www.phpnews.it/download/ZF-auth.zip>questo link</a>.</p><hr><h3 id=il-file-di-bootstrap>Il file di bootstrap</h3><p>Il file di bootstrap utilizzato per questa semplice applicazione non contiene importanti variazioni rispetto a quello analizzato in dettaglio nel <a href=http://www.phpnews.it/articoli/zend-framework/zend-framework-tutorial-1/>tutorial sullo Zend Framework</a> al quale rimando per eventuali approfondimenti.</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
&lt;?php
set_include_path(get_include_path().PATH_SEPARATOR.'C:\Programmi\ZendFramework\library');

require_once('Zend/Loader.php');

Zend_Loader::registerAutoload();

date_default_timezone_set('Europe/Rome');

try {
   $db = Zend_Db::factory('Pdo_Mysql', array(
   'host'     =&gt; 'localhost',
   'username' =&gt; 'root',
   'password' =&gt; 'secret',
   'dbname'   =&gt; 'ZF-auth'
   ));

   $db-&gt;getConnection();
} catch (Zend_Db_Adapter_Exception $e) {
   die(&quot;Zend_Db_Adapter_Exception: &quot;.$e-&gt;getMessage());
} catch (Zend_Exception $e) {
   die(&quot;Zend_Exception&quot;.$e-&gt;getMessage());
}

Zend_Registry::set('db', $db);

define('BASE_URL', str_replace('index.php','',$_SERVER['PHP_SELF']));
Zend_Controller_Front::run('controllers');
?&gt;
</code></pre><hr><h3 id=indexcontroller>IndexController</h3><p>Considerato lo scopo didattico di questa applicazione e senza perdere di generalità, si è scelto di implementare tutto il sistema di login e logout direttamente nell&rsquo;IndexController. Analizziamo il funzionamento delle diverse Action:</p><p><strong>indexAction</strong>: quando viene mostrata la pagina principale di login (nel nostro caso si tratta dell&rsquo;unica pagina realizzata) dobbiamo semplicemente passare al template i dati relativi ad un eventuale utente loggato. In questo modo il template potrà mostrare un messaggio di benvenuto personalizzato.</p><p><strong>loginAction</strong>: questa action viene invocata quando l&rsquo;utente effettua il submit del form di login. Per verificare le credenziali ricevute bisogna prima effettuare il setup di Zend_Auth_Adapter_DbTable. Dopo aver verificato che username e password non sono vuote, passiamo questi dati all&rsquo;Adapter e li verifichiamo chiamando authenticate(). Attraverso $result controlliamo l&rsquo;esito della procedura. In caso di errore mostreremo un messaggio. Se invece l&rsquo;utente viene riconosciuto memorizziamo nello Storage lo user_id ed il nome dell&rsquo;utente. La procedura si conclude con il redirect alla stessa pagina di login.</p><p><strong>logoutAction</strong>: viene invocata dall&rsquo;utente cliccando su un link &ldquo;logout&rdquo;. L&rsquo;operazione richiede semplicemente l&rsquo;esecuzione del metodo clearIdentity() di Zend_Auth.</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;
&lt;?php
class IndexController extends Zend_Controller_Action
{
   protected $_flashMessenger = null;

   public function init()
   {
       $this-&gt;_flashMessenger = $this-&gt;_helper-&gt;getHelper('FlashMessenger');
       $this-&gt;view-&gt;messaggi = $this-&gt;_flashMessenger-&gt;getMessages();
   }

   public function indexAction()
   {
       $this-&gt;view-&gt;identity = Zend_Auth::getInstance()-&gt;getIdentity();
   }

   public function loginAction()
   {
       $db = Zend_Registry::get('db');

       $my_auth_adapter = new Zend_Auth_Adapter_DbTable($db, 'users', 'user_name', 'password', 'MD5(?)');

       $username = trim($this-&gt;_getParam('username'));
       $password = trim($this-&gt;_getParam('password'));

       // non possiamo invocare authenticate() se username o password sono vuoti
       // altrimenti Zend_Auth_Adapter_DbTable solleva una eccezione
       if(!$username || ! $password) {
           $this-&gt;_flashMessenger-&gt;addMessage('Username o password non inserita');
           $this-&gt;_redirect('/');
       }

       $my_auth_adapter-&gt;setIdentity($username)-&gt;setCredential($password);

       $result = $my_auth_adapter-&gt;authenticate();

       // dal codice contenuto nel risultato dell'autenticazione recuperiamo l'esito
       // potevamo usare semplicemente $result-&gt;isValid()
       switch ($result-&gt;getCode()){
           //Login riuscito.
           case Zend_Auth_Result::SUCCESS :
               // la verifica è andata a buon fine
               // dobbiamo quindi memorizzare i dati dell'utente nello Storage di Zend_Auth (Zend_Auth_Storage_Session)
               // non memorizziamo tutti i dati del record della tabella relativa all'utente ma solo quelli di nostro interesse
                Zend_Auth::getInstance()-&gt;getStorage()-&gt;write($my_auth_adapter-&gt;getResultRowObject(array('user_id', 'nome')));

                // per memorizzare tutti i dati del record, tranne la password
                //$this-&gt;_auth-&gt;getStorage()-&gt;write($adapter-&gt;getResultRowObject(null, 'password'));
               break;
               //Username non trovato
           case Zend_Auth_Result::FAILURE_IDENTITY_NOT_FOUND :
               $this-&gt;_flashMessenger-&gt;addMessage('Username non trovato');
               break;
               //Password non corretta
           case Zend_Auth_Result::FAILURE_CREDENTIAL_INVALID :
               $this-&gt;_flashMessenger-&gt;addMessage('Password errata');
               break;
               //Errore sconosciuto
           default:
               $this-&gt;_flashMessenger-&gt;addMessage('Errore Sconosciuto');
               break;
       }
       $this-&gt;_redirect('/');
   }

   public function logoutAction()
   {
       // per effettuare il logout basta cancellare i dati dell'utente corrente
       // memorizzati in Zend_Auth_Storage_Session
       // con il seguente metodo sarà lo Zend_Auth ad occuparsene
       Zend_Auth::getInstance()-&gt;clearIdentity();
       $this-&gt;_flashMessenger-&gt;addMessage('Log-out effettuato con successo.');
       $this-&gt;_redirect('/');
   }
}
?&gt;
</code></pre><hr><h3 id=il-template>Il template</h3><p>Di seguito viene riportato l&rsquo;unico template presente nella nostra piccola applicazione web. Per gli utenti non ancora identificati è necessario mostrare il form di login mentre per gli utenti loggati bisogna mostrare un messaggio di benvenuto personalizzato ed un link per il logout. Questa distinzione viene realizzata con un semplice IF che interroga il metodo hasIdentity() di Zend_Auth. Si noti infine l&rsquo;utilizzo di $this->identity->nome per recuperare il nome dell&rsquo;utente corrente da mostrare nel messaggio di benvenuto.</p><p>Anche in questo caso si rimanda al tutorial sullo Zend Framework per i dettagli sulle altre funzioni presenti.</p><pre><code>&lt;pre class=&quot;brush: php&quot;&gt;

&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; lang=&quot;it&quot; xml:lang=&quot;it&quot;&gt;
&lt;head&gt;
   &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot; /&gt;
   &lt;title&gt;Zend_Auth Tutorial&lt;/title&gt;
   &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;screen, handheld, print&quot; href=&quot;&lt;?php echo BASE_URL?&gt;main.css&quot; /&gt;
&lt;/head&gt;
&lt;body&gt;
   &lt;div id=&quot;page&quot;&gt;
       &lt;h1&gt;Home page&lt;/h1&gt;
&lt;p class=&quot;errore&quot;&gt;&lt;?php echo $this-&gt;escape($this-&gt;messaggi[0])?&gt;&lt;/p&gt;
&lt;?php if (!Zend_Auth::getInstance()-&gt;hasIdentity()): ?&gt;
   &lt;form action=&quot;&lt;?php echo BASE_URL?&gt;index/login&quot; method=&quot;post&quot;&gt;
   &lt;fieldset&gt;
   &lt;legend&gt;Login&lt;/legend&gt;
   &lt;p&gt;&lt;label&gt;Username:&lt;br /&gt;
   &lt;?php echo $this-&gt;formText('username')?&gt;&lt;/label&gt;&lt;/p&gt;
   &lt;p&gt;&lt;label&gt;Password:&lt;br /&gt;
   &lt;?php echo $this-&gt;formPassword('password')?&gt;&lt;/label&gt;&lt;/p&gt;
   &lt;p&gt;&lt;?php echo $this-&gt;formSubmit('submit', 'Login')?&gt;&lt;/p&gt;
   &lt;/fieldset&gt;
&lt;/form&gt;
&lt;?php else: ?&gt;
   &lt;p&gt;Benvenuto &lt;?php echo $this-&gt;escape($this-&gt;identity-&gt;nome)?&gt;&lt;/p&gt;
   &lt;p&gt;&lt;a href=&quot;&lt;?php echo BASE_URL?&gt;index/logout&quot;&gt;log-out&lt;/a&gt;
&lt;?php endif; ?&gt;
   &lt;/div&gt;
   &lt;/body&gt;
&lt;/html&gt;
</code></pre></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/database/ rel=tag>database</a></li><li class=tags__item><a class="tags__link btn" href=/tags/zend-framework/ rel=tag>Zend Framework</a></li><li class=tags__item><a class="tags__link btn" href=/tags/mysql/ rel=tag>MySQL</a></li><li class=tags__item><a class="tags__link btn" href=/tags/crittografia/ rel=tag>crittografia</a></li><li class=tags__item><a class="tags__link btn" href=/tags/css/ rel=tag>CSS</a></li><li class=tags__item><a class="tags__link btn" href=/tags/exception/ rel=tag>exception</a></li><li class=tags__item><a class="tags__link btn" href=/tags/xml/ rel=tag>XML</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/articoli/autenticare-gli-utenti-con-zend-auth-1/ rel=prev><span class=pager__subtitle>«&#8201;Precedente</span><p class=pager__title>Autenticare gli utenti con Zend_Auth - 1</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/articoli/paginazione-dei-dati/ rel=next><span class=pager__subtitle>Prossimo&#8201;»</span><p class=pager__title>Paginazione dei dati</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Giovanni Tomasicchio.
<span class=footer__copyright-credits>Generato con <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> e il tema <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>