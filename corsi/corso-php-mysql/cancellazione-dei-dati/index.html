<!doctype html><html class=no-js lang=it><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Cancellazione dei dati - Giovanni Tomasicchio</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Cancellare un record di una tabella MySQL con PHP. Eseguire una DELETE con PHP e MySQL."><meta property="og:title" content="Cancellazione dei dati"><meta property="og:description" content="Cancellare un record di una tabella MySQL con PHP. Eseguire una DELETE con PHP e MySQL."><meta property="og:type" content="article"><meta property="og:url" content="https://giovannitomasicchio.github.io/corsi/corso-php-mysql/cancellazione-dei-dati/"><meta property="article:section" content="corsi"><meta property="article:published_time" content="2006-08-26T18:03:06+00:00"><meta property="article:modified_time" content="2006-08-26T18:03:06+00:00"><meta itemprop=name content="Cancellazione dei dati"><meta itemprop=description content="Cancellare un record di una tabella MySQL con PHP. Eseguire una DELETE con PHP e MySQL."><meta itemprop=datePublished content="2006-08-26T18:03:06+00:00"><meta itemprop=dateModified content="2006-08-26T18:03:06+00:00"><meta itemprop=wordCount content="827"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Cancellazione dei dati"><meta name=twitter:description content="Cancellare un record di una tabella MySQL con PHP. Eseguire una DELETE con PHP e MySQL."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,regular,italic,600,600italic,700,700italic,800,800italic|Kaushan+Script:regular"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-525H86QENV"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-525H86QENV',{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Giovanni Tomasicchio" rel=home><div class="logo__item logo__text"><div class=logo__title>Giovanni Tomasicchio</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/articoli/><span class=menu__text>Articoli PHP</span></a></li><li class=menu__item><a class=menu__link href=/corsi/><span class=menu__text>Corsi</span></a></li><li class=menu__item><a class=menu__link href=/contatti/><span class=menu__text>Contatti</span></a></li><li class=menu__item><a class=menu__link href=/ricerca/><span class=menu__text>Ricerca</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Cancellazione dei dati</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2006-08-26T18:03:06Z>26 August 2006</time></div></div></header><div class="content post__content clearfix"><p>La cancellazione di record presenti in una tabella è un&rsquo;operazione che richiede l&rsquo;esecuzione di una semplice query. Ad esempio per cancellare dalla tabella utenti il record con id pari a 5 basta lanciare la seguente query.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> utenti <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</code></pre></div><p>Per eseguire questa cancellazione in PHP è sufficiente quindi il seguente script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#75715e>// richiamo il file di configurazione
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;config.php&#39;</span>;

<span style=color:#75715e>// richiamo lo script responsabile della connessione a MySQL
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;connect.php&#39;</span>;

<span style=color:#75715e>// preparo la query
</span><span style=color:#75715e></span>$query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DELETE FROM utenti WHERE id = 5&#34;</span>;

<span style=color:#75715e>// invio la query
</span><span style=color:#75715e></span>$result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_query</span>($query);

<span style=color:#75715e>// controllo l&#39;esito
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$result) {
   <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Errore nella query </span><span style=color:#e6db74>$query</span><span style=color:#e6db74>: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>mysql_error</span>());
}

<span style=color:#75715e>// chiudo la connessione a MySQL
</span><span style=color:#75715e></span><span style=color:#a6e22e>mysql_close</span>();

<span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;Query eseguita correttamente&#39;</span>;
<span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Di solito però lo script che deve cancellare dei dati non sa a priori quale record eliminare. In un contesto interattivo è l&rsquo;utente ad indicare cosa cancellare, e lo fa cliccando su di un link o selezionando in altro modo i record da eliminare. Lo script quindi dovrebbe occuparsi di mostrare i dati all&rsquo;utente, permettergli di selezionare quelli da cancellare, ed infine effettuare l&rsquo;operazione.</p><p>Vediamo quindi come realizzare uno script che mostra l&rsquo;elenco dei record presenti nella tabella &ldquo;utenti&rdquo;, associando a ciascuno di essi un link e una checkbox attraverso cui selezionare quelli da eliminare. Lo script verrà suddiviso in due pari, la prima adibita alla creazione dell&rsquo;elenco di record disponibili, con relativi link e checkbox, la seconda per l&rsquo;eliminazione del record identificato dall&rsquo;id passato via $_GET o via $_POST.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#75715e>// richiamo il file di configurazione
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;config.php&#39;</span>;

<span style=color:#75715e>// richiamo lo script responsabile della connessione a MySQL
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;connect.php&#39;</span>;

<span style=color:#66d9ef>if</span>($_POST)
{
   $ids <span style=color:#f92672>=</span> <span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;id&#39;</span>]) <span style=color:#f92672>?</span> $_POST[<span style=color:#e6db74>&#39;id&#39;</span>] <span style=color:#f92672>:</span> <span style=color:#66d9ef>array</span>();
   <span style=color:#a6e22e>elimina_record</span>($ids);
}
<span style=color:#66d9ef>elseif</span>(<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;id&#39;</span>]))
{
   <span style=color:#a6e22e>elimina_record</span>(<span style=color:#66d9ef>array</span>($_GET[<span style=color:#e6db74>&#39;id&#39;</span>]));
}
<span style=color:#66d9ef>else</span>
   <span style=color:#a6e22e>mostra_lista</span>();

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mostra_lista</span>()
{
   <span style=color:#75715e>// mostro un eventuale messaggio
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;msg&#39;</span>]))
       <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;&lt;b&gt;&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>htmlentities</span>($_GET[<span style=color:#e6db74>&#39;msg&#39;</span>])<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&#39;</span>;

   <span style=color:#75715e>// preparo la query
</span><span style=color:#75715e></span>   $query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SELECT id,nome FROM utenti&#34;</span>;

   <span style=color:#75715e>// invio la query
</span><span style=color:#75715e></span>   $result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_query</span>($query);

   <span style=color:#75715e>// controllo l&#39;esito
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$result) {
       <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Errore nella query </span><span style=color:#e6db74>$query</span><span style=color:#e6db74>: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>mysql_error</span>());
   }

   <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>   &lt;form name=&#34;form1&#34; method=&#34;post&#34; action=&#34;&#34;&gt;
</span><span style=color:#e6db74>   &lt;table border=&#34;1&#34;&gt;
</span><span style=color:#e6db74>       &lt;tr&gt;
</span><span style=color:#e6db74>           &lt;th&gt;&amp;nbsp;&lt;/th&gt;
</span><span style=color:#e6db74>           &lt;th&gt;Nome&lt;/th&gt;
</span><span style=color:#e6db74>           &lt;th&gt;&amp;nbsp;&lt;/th&gt;
</span><span style=color:#e6db74>       &lt;/tr&gt;&#39;</span>;

   <span style=color:#66d9ef>while</span> ($row <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_fetch_assoc</span>($result))
   {
       $nome <span style=color:#f92672>=</span> <span style=color:#a6e22e>htmlentities</span>($row[<span style=color:#e6db74>&#39;nome&#39;</span>]);

       <span style=color:#75715e>// preparo il link per la modifica dei dati del record
</span><span style=color:#75715e></span>       $link <span style=color:#f92672>=</span> $_SERVER[<span style=color:#e6db74>&#39;PHP_SELF&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;?id=&#39;</span> <span style=color:#f92672>.</span> $row[<span style=color:#e6db74>&#39;id&#39;</span>];

       <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;tr&gt;
</span><span style=color:#e6db74>               &lt;td&gt;&lt;input name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>id[]</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> type=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>checkbox</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> value=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$row[id]</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> /&gt;&lt;/td&gt;
</span><span style=color:#e6db74>               &lt;td&gt;</span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>&lt;/td&gt;
</span><span style=color:#e6db74>               &lt;td&gt;&lt;a href=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$link\</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#a6e22e>elimina</span><span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>a</span><span style=color:#f92672>&gt;&lt;/</span><span style=color:#a6e22e>td</span><span style=color:#f92672>&gt;</span>
           <span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>tr</span><span style=color:#f92672>&gt;</span><span style=color:#e6db74>&#34;;
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   echo &#39;&lt;/table&gt;
</span><span style=color:#e6db74>       &lt;br /&gt;
</span><span style=color:#e6db74>       &lt;input type=&#34;</span><span style=color:#a6e22e>submit</span><span style=color:#e6db74>&#34; name=&#34;</span><span style=color:#a6e22e>Submit</span><span style=color:#e6db74>&#34; value=&#34;</span><span style=color:#a6e22e>Elimina</span> <span style=color:#a6e22e>record</span> <span style=color:#a6e22e>selezionati</span><span style=color:#e6db74>&#34; /&gt;
</span><span style=color:#e6db74>       &lt;/form&gt;&#39;;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // libero la memoria di PHP occupata dai record estratti con la SELECT
</span><span style=color:#e6db74>   mysql_free_result(</span><span style=color:#e6db74>$result</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // chiudo la connessione a MySQL
</span><span style=color:#e6db74>   mysql_close();
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>function elimina_record(</span><span style=color:#e6db74>$ids</span><span style=color:#e6db74>)
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>   // verifico che almeno un id sia stato selezionato
</span><span style=color:#e6db74>   if(count(</span><span style=color:#e6db74>$ids</span><span style=color:#e6db74>) &lt; 1)
</span><span style=color:#e6db74>   {
</span><span style=color:#e6db74>       </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = urlencode(&#34;</span><span style=color:#a6e22e>Nessun</span> <span style=color:#a6e22e>record</span> <span style=color:#a6e22e>selezionato</span><span style=color:#f92672>!</span><span style=color:#e6db74>&#34;);
</span><span style=color:#e6db74>       header(&#39;location: &#39;.</span><span style=color:#e6db74>$_SERVER[&#39;PHP_SELF&#39;]</span><span style=color:#e6db74>.&#39;?msg=&#39;.</span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>       exit;
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // per precauzione converto gli ID in interi
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$ids</span><span style=color:#e6db74> = array_map(&#39;intval&#39;,</span><span style=color:#e6db74>$ids</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // creo una lista di ID per la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$ids</span><span style=color:#e6db74> = implode(&#39;,&#39;,</span><span style=color:#e6db74>$ids</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // preparo la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$query</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>DELETE</span> <span style=color:#a6e22e>FROM</span> <span style=color:#a6e22e>utenti</span> <span style=color:#a6e22e>WHERE</span> <span style=color:#a6e22e>id</span> <span style=color:#a6e22e>IN</span> ($ids)<span style=color:#e6db74>&#34;;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // invio la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$result</span><span style=color:#e6db74> = mysql_query(</span><span style=color:#e6db74>$query</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // controllo l&#39;esito
</span><span style=color:#e6db74>   if (!</span><span style=color:#e6db74>$result</span><span style=color:#e6db74>) {
</span><span style=color:#e6db74>       die(&#34;</span><span style=color:#a6e22e>Errore</span> <span style=color:#a6e22e>nella</span> <span style=color:#a6e22e>query</span> $query<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34; . mysql_error());
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // conto il numero di record cancellati
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$num_record</span><span style=color:#e6db74> = mysql_affected_rows();
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // chiudo la connessione a MySQL
</span><span style=color:#e6db74>   mysql_close();
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = urlencode(&#34;</span><span style=color:#a6e22e>Numero</span> <span style=color:#a6e22e>record</span> <span style=color:#a6e22e>cancellati</span><span style=color:#f92672>:</span> $num_record<span style=color:#e6db74>&#34;);
</span><span style=color:#e6db74>   header(&#39;location: &#39;.</span><span style=color:#e6db74>$_SERVER[&#39;PHP_SELF&#39;]</span><span style=color:#e6db74>.&#39;?msg=&#39;.</span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>?&gt;
</span></code></pre></div><p>La funzione mostra_lista() si occupa di creare l&rsquo;elenco dei record all&rsquo;interno di un form. Per ciascuno di essi viene mostrato il nome, a cui viene applicata la funzione htmlentities() per la conversione dei caratteri nelle relative entità HTML, il link per la cancellazione diretta e la checkbox di selezione.</p><p>La funzione elimina_record() invece provvede alla cancellazione dei record selezionati. Gli id dei record vengono passati all&rsquo;interno dell&rsquo;array $ids (riga 10,11,15). Questi vengono prima convertiti in numeri interi per precauzione (riga 83), trasformati in una stringa di id separai da virgola (riga 86) ed infine inseriti nella query (riga 89).</p><p>Eseguita la query vengono contati i record effettivamente interessati da questa operazione attraverso la funzione <strong>mysql_affected_rows()</strong> (riga 100) e viene effettuato un redirect all&rsquo;URL corrente per evitare possibili problemi legati al refresh della pagina, come visto nella Lezione 5. Anche in questo caso un messaggio viene accodato all&rsquo;URL che verrà visualizzato all&rsquo;inizio della funzione mostra_lista().</p><p>Un punto debole dello script presentato risiede nel passaggio degli id dei record da cancellare attraverso un link ($_GET) o una checkbox ($_POST), elementi comunque accessibili all&rsquo;utente e pertanto soggetti a manomissione. Supponiamo ad esempio che un utente abbia i permessi sufficienti per poter cancellare solo i record con id compreso tra 1 e 10. La funzione mostra_lista() deve quindi mostrare solo questi record ma nulla vieta all&rsquo;utente di manomettere un link per la cancellazione inserendo un id superiore a 10. Senza nessun controllo quindi l&rsquo;utente potrebbe eliminare record su cui non ha i permessi. Diverse le possibili soluzioni al problema. Prima di effettuare la DELETE si potrebbe verificare che l&rsquo;id passato sia tra quelli accessibili all&rsquo;utente impiegando la stessa logica usata da mostra_lista() per la loro individuazione. Se tale procedimento risulta oneroso mostra_lista() potrebbe salvare in sessione gli id dei record accessibili all&rsquo;utente. Contro la manomissione dei link esiste anche una particolare tecnica denominata HMAC implementata nel package <a href=http://pear.php.net/package/Crypt_HMAC>PEAR::Crypt_HMAC</a>.</p></div></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/corsi/corso-php-mysql/selezione-dei-dati-e-recupero-dei-risultati-ii/ rel=prev><span class=pager__subtitle>«&#8201;Precedente</span><p class=pager__title>Selezione dei dati e recupero dei risultati - II</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/corsi/corso-php-mysql/aggiornamento-dei-dati/ rel=next><span class=pager__subtitle>Prossimo&#8201;»</span><p class=pager__title>Aggiornamento dei dati</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//giovannitomasicchio-it.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Giovanni Tomasicchio.
<span class=footer__copyright-credits>Generato con <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> e il tema <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>