<!doctype html><html class=no-js lang=it><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Aggiornamento dei dati - Giovanni Tomasicchio</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Modificare i dati di una tabella MySQL con PHP. Eseguide una UPDATE con PHP e MySQL"><meta property="og:title" content="Aggiornamento dei dati"><meta property="og:description" content="Modificare i dati di una tabella MySQL con PHP. Eseguide una UPDATE con PHP e MySQL"><meta property="og:type" content="article"><meta property="og:url" content="https://giovannitomasicchio.github.io/corsi/corso-php-mysql/aggiornamento-dei-dati/"><meta property="article:section" content="corsi"><meta property="article:published_time" content="2006-08-26T18:03:26+00:00"><meta property="article:modified_time" content="2006-08-26T18:03:26+00:00"><meta itemprop=name content="Aggiornamento dei dati"><meta itemprop=description content="Modificare i dati di una tabella MySQL con PHP. Eseguide una UPDATE con PHP e MySQL"><meta itemprop=datePublished content="2006-08-26T18:03:26+00:00"><meta itemprop=dateModified content="2006-08-26T18:03:26+00:00"><meta itemprop=wordCount content="1451"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Aggiornamento dei dati"><meta name=twitter:description content="Modificare i dati di una tabella MySQL con PHP. Eseguide una UPDATE con PHP e MySQL"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,regular,italic,600,600italic,700,700italic,800,800italic|Kaushan+Script:regular"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-525H86QENV"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-525H86QENV',{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Giovanni Tomasicchio" rel=home><div class="logo__item logo__text"><div class=logo__title>Giovanni Tomasicchio</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/articoli/><span class=menu__text>Articoli PHP</span></a></li><li class=menu__item><a class=menu__link href=/corsi/><span class=menu__text>Corsi</span></a></li><li class=menu__item><a class=menu__link href=/contatti/><span class=menu__text>Contatti</span></a></li><li class=menu__item><a class=menu__link href=/ricerca/><span class=menu__text>Ricerca</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Aggiornamento dei dati</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2006-08-26T18:03:26Z>26 August 2006</time></div></div></header><div class="content post__content clearfix"><p>L&rsquo;aggiornamento dei dati presenti in una tabella MySQL è affidato ad una query di tipo UPDATE. Ad esempio, per modificare i dati associati al record con id = 5 della tabella &ldquo;utenti&rdquo; potremmo impiegare la seguente query:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>UPDATE</span> 
  utenti
<span style=color:#66d9ef>SET</span>
  nome <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Mario&#39;</span>,
  email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;mario@email.it&#39;</span>,
  sesso <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
  newsletter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
  attivita <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>,
  messaggio <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ciao a tutti!&#39;</span>
<span style=color:#66d9ef>WHERE</span>
  id <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</code></pre></div><p>La semplice esecuzione della query in PHP richiede la realizzazione di un banale script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#75715e>// richiamo il file di configurazione
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;config.php&#39;</span>;

<span style=color:#75715e>// richiamo lo script responsabile della connessione a MySQL
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;connect.php&#39;</span>;

<span style=color:#75715e>// preparo la query di aggiornamento
</span><span style=color:#75715e></span>$query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;UPDATE utenti SET
</span><span style=color:#e6db74>               nome = &#39;Mario&#39;,
</span><span style=color:#e6db74>               email = &#39;mario@email.it&#39;,
</span><span style=color:#e6db74>               sesso = 1,
</span><span style=color:#e6db74>               newsletter = 0,
</span><span style=color:#e6db74>               attivita = 2,
</span><span style=color:#e6db74>               messaggio = &#39;Ciao a tutti!&#39;
</span><span style=color:#e6db74>               WHERE id = 5&#34;</span>;

<span style=color:#75715e>// invio la query
</span><span style=color:#75715e></span>$result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_query</span>($query);

<span style=color:#75715e>// controllo l&#39;esito
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$result) {
   <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Errore nella query </span><span style=color:#e6db74>$query</span><span style=color:#e6db74>: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>mysql_error</span>());
}

<span style=color:#75715e>// chiudo la connessione a MySQL
</span><span style=color:#75715e></span><span style=color:#a6e22e>mysql_close</span>();

<span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;Query eseguita correttamente&#39;</span>;
<span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Similmente a quanto visto nelle precedenti lezioni, anche l&rsquo;aggiornamento dei dati all&rsquo;interno di una reale applicazione web può richiedere ulteriori accorgimenti. Spesso infatti è necessario interagire con l&rsquo;utente per determinare quale record aggiornare. Inoltre, se è l&rsquo;utente a dover inserire i nuovi dati, è conveniente che possa farlo partendo da quelli attualmente presenti nel record. Un ipotetico script interattivo per la modifica dei dati della tabella &ldquo;utenti&rdquo; quindi dovrà prevedere le seguenti fasi:</p><ul><li>mostrare un elenco dei record presenti nella tabella, associando a ciascuno un link che punta alla pagina di modifica dei relativi dati;</li><li>mostrare un form contenente i dati correntemente associati al record selezionato;</li><li>aggiornare i dati del record con quelli inviati dall&rsquo;utente attraverso il form.</li></ul><p>Vediamo il codice necessario a realizzare questo script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#75715e>// richiamo il file di configurazione
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;config.php&#39;</span>;

<span style=color:#75715e>// richiamo lo script responsabile della connessione a MySQL
</span><span style=color:#75715e></span><span style=color:#66d9ef>require</span> <span style=color:#e6db74>&#39;connect.php&#39;</span>;

<span style=color:#66d9ef>if</span>($_POST <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;id&#39;</span>]))
{
   <span style=color:#a6e22e>aggiorna_record</span>();
}
<span style=color:#66d9ef>elseif</span>(<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;id&#39;</span>]))
{
   <span style=color:#a6e22e>mostra_record</span>();
}
<span style=color:#66d9ef>else</span>
   <span style=color:#a6e22e>mostra_lista</span>();

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mostra_lista</span>()
{
   <span style=color:#75715e>// mostro un eventuale messaggio
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;msg&#39;</span>]))
       <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;&lt;b&gt;&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>htmlentities</span>($_GET[<span style=color:#e6db74>&#39;msg&#39;</span>])<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&#39;</span>;

   <span style=color:#75715e>// preparo la query
</span><span style=color:#75715e></span>   $query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SELECT id,nome FROM utenti&#34;</span>;

   <span style=color:#75715e>// invio la query
</span><span style=color:#75715e></span>   $result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_query</span>($query);

   <span style=color:#75715e>// controllo l&#39;esito
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$result) {
       <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Errore nella query </span><span style=color:#e6db74>$query</span><span style=color:#e6db74>: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>mysql_error</span>());
   }

   <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>   &lt;table border=&#34;1&#34;&gt;
</span><span style=color:#e6db74>       &lt;tr&gt;
</span><span style=color:#e6db74>           &lt;th&gt;Nome&lt;/th&gt;
</span><span style=color:#e6db74>           &lt;th&gt;&amp;nbsp;&lt;/th&gt;
</span><span style=color:#e6db74>       &lt;/tr&gt;&#39;</span>;

   <span style=color:#66d9ef>while</span> ($row <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_fetch_assoc</span>($result))
   {
       $nome <span style=color:#f92672>=</span> <span style=color:#a6e22e>htmlspecialchars</span>($row[<span style=color:#e6db74>&#39;nome&#39;</span>]);

       <span style=color:#75715e>// preparo il link per la modifica dei dati del record
</span><span style=color:#75715e></span>       $link <span style=color:#f92672>=</span> $_SERVER[<span style=color:#e6db74>&#39;PHP_SELF&#39;</span>] <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;?id=&#39;</span> <span style=color:#f92672>.</span> $row[<span style=color:#e6db74>&#39;id&#39;</span>];

       <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;tr&gt;
</span><span style=color:#e6db74>               &lt;td&gt;</span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>&lt;/td&gt;
</span><span style=color:#e6db74>               &lt;td&gt;&lt;a href=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$link\</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#a6e22e>modifica</span><span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>a</span><span style=color:#f92672>&gt;&lt;/</span><span style=color:#a6e22e>td</span><span style=color:#f92672>&gt;</span>
           <span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>tr</span><span style=color:#f92672>&gt;</span><span style=color:#e6db74>&#34;;
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   echo &#39;&lt;/table&gt;&#39;;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // libero la memoria di PHP occupata dai record estratti con la SELECT
</span><span style=color:#e6db74>   mysql_free_result(</span><span style=color:#e6db74>$result</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // chiudo la connessione a MySQL
</span><span style=color:#e6db74>   mysql_close();
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>function aggiorna_record()
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>   // recupero i campi di tipo &#34;</span><span style=color:#a6e22e>stringa</span><span style=color:#e6db74>&#34;
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>      = trim(</span><span style=color:#e6db74>$_POST[&#39;nome&#39;]</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$email</span><span style=color:#e6db74>     = trim(</span><span style=color:#e6db74>$_POST[&#39;email&#39;]</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = trim(</span><span style=color:#e6db74>$_POST[&#39;messaggio&#39;]</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // verifico se devo eliminare gli slash inseriti automaticamente da PHP
</span><span style=color:#e6db74>   if(get_magic_quotes_gpc())
</span><span style=color:#e6db74>   {
</span><span style=color:#e6db74>       </span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>      = stripslashes(</span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>       </span><span style=color:#e6db74>$email</span><span style=color:#e6db74>     = stripslashes(</span><span style=color:#e6db74>$email</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>       </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = stripslashes(</span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // effettuo l&#39;escape dei caratteri speciali per inserirli all&#39;interno della query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>      = mysql_real_escape_string(</span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$email</span><span style=color:#e6db74>     = mysql_real_escape_string(</span><span style=color:#e6db74>$email</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = mysql_real_escape_string(</span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // recupero gli altri campi del form
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$sesso</span><span style=color:#e6db74>      = isset(</span><span style=color:#e6db74>$_POST[&#39;sesso&#39;]</span><span style=color:#e6db74>) ? intval(</span><span style=color:#e6db74>$_POST[&#39;sesso&#39;]</span><span style=color:#e6db74>) : 0;
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$newsletter</span><span style=color:#e6db74> = isset(</span><span style=color:#e6db74>$_POST[&#39;newsletter&#39;]</span><span style=color:#e6db74>) ? 1 : 0;
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$attivita</span><span style=color:#e6db74>   = intval(</span><span style=color:#e6db74>$_POST[&#39;attivita&#39;]</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$id</span><span style=color:#e6db74> = intval(</span><span style=color:#e6db74>$_GET[&#39;id&#39;]</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // verifico la presenza dei campi obbligatori
</span><span style=color:#e6db74>   if(!</span><span style=color:#e6db74>$nome</span><span style=color:#e6db74>)
</span><span style=color:#e6db74>   {
</span><span style=color:#e6db74>       </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = urlencode(&#34;</span><span style=color:#a6e22e>Non</span> <span style=color:#a6e22e>hai</span> <span style=color:#a6e22e>inserito</span> <span style=color:#a6e22e>il</span> <span style=color:#a6e22e>nome</span><span style=color:#e6db74>&#34;);
</span><span style=color:#e6db74>       header(&#34;</span><span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> $_SERVER[<span style=color:#a6e22e>PHP_SELF</span>]<span style=color:#f92672>?</span><span style=color:#a6e22e>id</span><span style=color:#f92672>=</span>$id<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>msg</span><span style=color:#f92672>=</span>$messaggio<span style=color:#e6db74>&#34;);
</span><span style=color:#e6db74>       exit;
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // preparo la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$query</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>UPDATE</span> <span style=color:#a6e22e>utenti</span> <span style=color:#a6e22e>SET</span>
               <span style=color:#a6e22e>nome</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;$nome&#39;</span>,
               <span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;$email&#39;</span>,
               <span style=color:#a6e22e>sesso</span> <span style=color:#f92672>=</span> $sesso,
               <span style=color:#a6e22e>newsletter</span> <span style=color:#f92672>=</span> $newsletter,
               <span style=color:#a6e22e>attivita</span> <span style=color:#f92672>=</span> $attivita,
               <span style=color:#a6e22e>messaggio</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;$messaggio&#39;</span>
               <span style=color:#a6e22e>WHERE</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> $id<span style=color:#e6db74>&#34;;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // invio la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$result</span><span style=color:#e6db74> = mysql_query(</span><span style=color:#e6db74>$query</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // controllo l&#39;esito
</span><span style=color:#e6db74>   if (!</span><span style=color:#e6db74>$result</span><span style=color:#e6db74>) {
</span><span style=color:#e6db74>       die(&#34;</span><span style=color:#a6e22e>Errore</span> <span style=color:#a6e22e>nella</span> <span style=color:#a6e22e>query</span> $query<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34; . mysql_error());
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // chiudo la connessione a MySQL
</span><span style=color:#e6db74>   mysql_close();
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$messaggio</span><span style=color:#e6db74> = urlencode(&#39;Aggiornamento effettuato con successo&#39;);
</span><span style=color:#e6db74>   header(&#34;</span><span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> $_SERVER[<span style=color:#a6e22e>PHP_SELF</span>]<span style=color:#f92672>?</span><span style=color:#a6e22e>msg</span><span style=color:#f92672>=</span>$messaggio<span style=color:#e6db74>&#34;);
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>function mostra_record()
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>   // mostro un eventuale messaggio
</span><span style=color:#e6db74>   if(isset(</span><span style=color:#e6db74>$_GET[&#39;msg&#39;]</span><span style=color:#e6db74>))
</span><span style=color:#e6db74>       echo &#39;&lt;b&gt;&#39;.htmlentities(</span><span style=color:#e6db74>$_GET[&#39;msg&#39;]</span><span style=color:#e6db74>).&#39;&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&#39;;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$id</span><span style=color:#e6db74> = intval(</span><span style=color:#e6db74>$_GET[&#39;id&#39;]</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // preparo la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$query</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>SELECT</span> <span style=color:#a6e22e>nome</span>,<span style=color:#a6e22e>email</span>,<span style=color:#a6e22e>sesso</span>,<span style=color:#a6e22e>newsletter</span>,<span style=color:#a6e22e>attivita</span>,<span style=color:#a6e22e>messaggio</span> <span style=color:#a6e22e>FROM</span> <span style=color:#a6e22e>utenti</span> <span style=color:#a6e22e>WHERE</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> $id<span style=color:#e6db74>&#34;;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // invio la query
</span><span style=color:#e6db74>   </span><span style=color:#e6db74>$result</span><span style=color:#e6db74> = mysql_query(</span><span style=color:#e6db74>$query</span><span style=color:#e6db74>);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // controllo l&#39;esito
</span><span style=color:#e6db74>   if (!</span><span style=color:#e6db74>$result</span><span style=color:#e6db74>) {
</span><span style=color:#e6db74>       die(&#34;</span><span style=color:#a6e22e>Errore</span> <span style=color:#a6e22e>nella</span> <span style=color:#a6e22e>query</span> $query<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34; . mysql_error());
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   // controllo che la SELECT abbia restituito un record
</span><span style=color:#e6db74>   // l&#39;id passato via GET potrebbe essere stato manipolato
</span><span style=color:#e6db74>   if(mysql_num_rows(</span><span style=color:#e6db74>$result</span><span style=color:#e6db74>) != 1) {
</span><span style=color:#e6db74>       die(&#34;</span><span style=color:#a6e22e>l</span><span style=color:#e6db74>&#39;ID passato via GET è errato&#34;);
</span><span style=color:#e6db74>   }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   list($nome,$email,$sesso,$newsletter,$attivita,$messaggio) = mysql_fetch_row($result);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   $nome      = htmlspecialchars($nome);
</span><span style=color:#e6db74>   $email     = htmlspecialchars($email);
</span><span style=color:#e6db74>   $messaggio = htmlspecialchars($messaggio);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>   ?&gt;
</span><span style=color:#e6db74>   &lt;form name=&#34;form_registrazione&#34; method=&#34;post&#34; action=&#34;&#34;&gt;
</span><span style=color:#e6db74>     &lt;label&gt;nome:
</span><span style=color:#e6db74>     &lt;input name=&#34;nome&#34; type=&#34;text&#34; value=&#34;&lt;?echo $nome?&gt;&#34; /&gt;
</span><span style=color:#e6db74>     &lt;/label&gt;
</span><span style=color:#e6db74>     &lt;p&gt;
</span><span style=color:#e6db74>       &lt;label&gt;email:
</span><span style=color:#e6db74>       &lt;input name=&#34;email&#34; type=&#34;text&#34; value=&#34;&lt;?echo $email?&gt;&#34; /&gt;
</span><span style=color:#e6db74>       &lt;/label&gt;
</span><span style=color:#e6db74>     &lt;/p&gt;
</span><span style=color:#e6db74>     &lt;p&gt; Sesso:
</span><span style=color:#e6db74>       &lt;label&gt;
</span><span style=color:#e6db74>       &lt;input type=&#34;radio&#34; name=&#34;sesso&#34; value=&#34;1&#34; &lt;?if($sesso==1) echo &#39;</span><span style=color:#a6e22e>checked</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;checked&#34;</span><span style=color:#e6db74>&#39;?&gt; /&gt;
</span><span style=color:#e6db74>       M&lt;/label&gt;
</span><span style=color:#e6db74>       &lt;label&gt;
</span><span style=color:#e6db74>       &lt;input type=&#34;radio&#34; name=&#34;sesso&#34; value=&#34;2&#34; &lt;?if($sesso==2) echo &#39;</span><span style=color:#a6e22e>checked</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;checked&#34;</span><span style=color:#e6db74>&#39;?&gt;/&gt;
</span><span style=color:#e6db74>       F&lt;/label&gt;
</span><span style=color:#e6db74>     &lt;/p&gt;
</span><span style=color:#e6db74>     &lt;p&gt;
</span><span style=color:#e6db74>       &lt;label&gt;inviami newletter:
</span><span style=color:#e6db74>       &lt;input name=&#34;newsletter&#34; type=&#34;checkbox&#34; value=&#34;1&#34; &lt;?if($newsletter) echo &#39;</span><span style=color:#a6e22e>checked</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;checked&#34;</span><span style=color:#e6db74>&#39;?&gt; /&gt;
</span><span style=color:#e6db74>       &lt;/label&gt;
</span><span style=color:#e6db74>     &lt;/p&gt;
</span><span style=color:#e6db74>     &lt;p&gt;
</span><span style=color:#e6db74>       &lt;label&gt;attivit&amp;agrave;:
</span><span style=color:#e6db74>       &lt;select name=&#34;attivita&#34;&gt;
</span><span style=color:#e6db74>         &lt;option value=&#34;0&#34;&gt;:: seleziona ::&lt;/option&gt;
</span><span style=color:#e6db74>         &lt;option value=&#34;1&#34; &lt;?if($attivita==1) echo &#39;</span><span style=color:#a6e22e>selected</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;selected&#34;</span><span style=color:#e6db74>&#39;?&gt;&gt;studente&lt;/option&gt;
</span><span style=color:#e6db74>         &lt;option value=&#34;2&#34; &lt;?if($attivita==2) echo &#39;</span><span style=color:#a6e22e>selected</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;selected&#34;</span><span style=color:#e6db74>&#39;?&gt;&gt;lavoratore&lt;/option&gt;
</span><span style=color:#e6db74>         &lt;option value=&#34;3&#34; &lt;?if($attivita==3) echo &#39;</span><span style=color:#a6e22e>selected</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;selected&#34;</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>&gt;disoccupato&lt;/option&gt;
</span><span style=color:#960050;background-color:#1e0010>       &lt;/select&gt;
</span><span style=color:#960050;background-color:#1e0010>       &lt;/label&gt;
</span><span style=color:#960050;background-color:#1e0010>     &lt;/p&gt;
</span><span style=color:#960050;background-color:#1e0010>     &lt;p&gt;
</span><span style=color:#960050;background-color:#1e0010>       &lt;label&gt;messaggio:&lt;br /&gt;
</span><span style=color:#960050;background-color:#1e0010>       &lt;textarea name=&#34;messaggio&#34; cols=&#34;40&#34; rows=&#34;5&#34;&gt;&lt;?echo $messaggio?&gt;&lt;/textarea&gt;
</span><span style=color:#960050;background-color:#1e0010>       &lt;/label&gt;
</span><span style=color:#960050;background-color:#1e0010>     &lt;/p&gt;
</span><span style=color:#960050;background-color:#1e0010>     &lt;p&gt;
</span><span style=color:#960050;background-color:#1e0010>       &lt;input name=&#34;invia&#34; type=&#34;submit&#34; value=&#34;Invia&#34; /&gt;
</span><span style=color:#960050;background-color:#1e0010>     &lt;/p&gt;
</span><span style=color:#960050;background-color:#1e0010>   &lt;/form&gt;
</span><span style=color:#960050;background-color:#1e0010>   &lt;?
</span><span style=color:#960050;background-color:#1e0010>}
</span><span style=color:#960050;background-color:#1e0010>?&gt;
</span></code></pre></div><p>Analizziamo nel dettaglio il funzionamento dello script. Per prima cosa è necessario capire in quale fase della procedura di aggiornamento ci troviamo. Per farlo verifichiamo la presenza di dati inviati dall&rsquo;utente ($_POST) e dell&rsquo;id del record passato attraverso un link ($_GET[&lsquo;id&rsquo;]). Se non è presente nessuno di questi dati allora viene richiamata la funzione mostra_lista(). Se invece è presente solo l&rsquo;id allora l&rsquo;utente avrà cliccato su un link e quindi mostriamo il form per la modifica dei dati, attraverso la funzione mostra_record(). Se infine è presente sia l&rsquo;id, sia i dati inviati col form allora procediamo all&rsquo;aggiornamento del record, richiamando aggiorna_record(). Le righe 8-17 fungono quindi da &ldquo;gestore degli eventi&rdquo; del nostro script</p><p>La funzione mostra_lista() si occupa di estrarre e visualizzare l&rsquo;elenco dei record presenti nella tabella &ldquo;utente&rdquo;, associando a ciascuno di essi un link per l&rsquo;aggiornamento dei dati (riga 48). Le righe 22-23 mostrano un eventuale messaggio generato da aggiorna_record(), funzione discussa in seguito. Si noti come i testi dinamici inseriti nella pagina vengono adeguatamente passati prima alla funzione htmlentities() per la conversione dei caratteri in entità HTML (righe 23,45).</p><p>La funzione mostra_record() recupera i dati associati al record da modificare, individuato da $_GET[&lsquo;id&rsquo;], e li inserisce in un form. La funzione intval() applicata a $_GET[&lsquo;id&rsquo;] ci assicura che l&rsquo;id passato alla query è costituito da un numero intero (riga 131). Effettuata l&rsquo;interrogazione al database viene verificata l&rsquo;effettiva restituzione del record (riga 146) come controllo sulla validità dell&rsquo;id. Anche in questo caso le stringhe dinamiche da inserire nel form ($nome, $email, $messaggio) vengono preventivamente passate alla funzione htmlentities() (righe 152-154).</p><p>La funzione aggiorna_record() ha infine il compito di effettuare la query di UPDATE con i nuovi dati inviati dall&rsquo;utente. Eliminati i possibili spazi vuoti alle estremità delle stringhe $nome, $email e $messaggio con la funzione trim (righe 68-70), la funzione si occupa di effettuare un corretto escape delle stesse (righe 73-83). Come ampiamente discusso nella <a href=/corsi/corso-php-mysql/inserimento-dati/>Lezione 5</a>, dapprima si eliminano i backslash eventualmente inseriti da PHP e poi si procede ad effettuare l&rsquo;escape con la funzione mysql_real_escape_string(). Viene verificato anche se l&rsquo;utente ha inserito del testo nel campo &ldquo;nome&rdquo; considerato obbligatorio nell&rsquo;esempio. In caso contrario viene ricaricata la pagina accodando all&rsquo;URL un messaggio esplicativo (righe 93-97). Se invece il controllo ha esito positivo si procede con l&rsquo;esecuzione della query di aggiornamento dati e si conclude lo script con un redirect del browser che riporta l&rsquo;utente alla fase iniziale. Si noti ancora una volta l&rsquo;uso fatto del redirect attraverso la funzione header() (righe 96, 122) come possibile soluzione al problema del refresh della pagina, già discusso nella <a href=/corsi/corso-php-mysql/selezione-dati-recupero-risultati-i/>Lezione 6</a>.</p><p>Tutta la logica di funzionamento dello script si basa sull&rsquo;id del record passato attraverso l&rsquo;URL ($_GET[&lsquo;id&rsquo;]) pertanto il codice è potenzialmente affetto da un problema di sicurezza legato alla possibile alterazione di tale valore da parte dell&rsquo;utente. Continuano a valere le considerazioni fatte a riguardo nella <a href=/corsi/corso-php-mysql/cancellazione-dati/>Lezione 8</a>.</p><p>Prima di concludere è doveroso fare un breve riepilogo ed alcune precisazioni sull&rsquo;uso della funzioni mysql_num_rows() e mysql_affected_rows() incontrate più volte nei precedenti esempi:</p><ul><li>mysql_num_rows() restituisce il numero di record appartenenti ad un result set, prodotto ad esempio (ma non solo!) da una query di tipo SELECT;</li><li>mysql_num_rows() non funziona correttamente con mysql_unbuffered_query(), poiché restituirà il risultato corretto solo al termine della procedura di fetch;</li><li>mysql_affected_rows() restituisce il numero di record realmente interessato dall&rsquo;ultima query di tipo INSERT, UPDATE o DELETE;</li><li>nelle versioni di MySQL precedenti alla 4.1.2, se viene effettuata una DELETE senza la clausola WHERE, mysql_affected_rows() restituisce sempre 0;</li><li>mysql_affected_rows() per una UPDATE non considera i record aggiornati con dati identici a quelli preesistenti. Solo i record realmente modificati vengono conteggiati. Tale comportamento può essere modificato passando il numero 2 come quinto parametro della mysql_connect(): mysql_connect(&ldquo;localhost&rdquo;, &ldquo;user&rdquo;, &ldquo;password&rdquo;, false, 2);</li><li>mysql_affected_rows() per una query di tipo REPLACE restituisce la somma dei record cancellati e di quelli inseriti;</li><li>se si è all&rsquo;interno di una transazione non bisogna attendere la COMMIT per eseguire mysql_affected_rows() ma è necessario lanciarla subito dopo la query di INSERT, UPDATE o DELETE.</li></ul></div></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/corsi/corso-php-mysql/cancellazione-dei-dati/ rel=prev><span class=pager__subtitle>«&#8201;Precedente</span><p class=pager__title>Cancellazione dei dati</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/corsi/corso-php-mysql/debug-degli-script-php-mysql/ rel=next><span class=pager__subtitle>Prossimo&#8201;»</span><p class=pager__title>Debug degli script PHP/MySQL</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//giovannitomasicchio-it.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Giovanni Tomasicchio.
<span class=footer__copyright-credits>Generato con <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> e il tema <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>